<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Аппроксимация кривой Безье 2-го порядка</title>
<script type="text/javascript">
	var cavnas1, context1, canvas2, context2;
	var width, height;
	var bezier_accuracy = 200;
	var points = { isDotGrabbed: 0, data: [] }; // Оригинальные точки
	var bezierpoints = { isDotGrabbed: 0, data: [] }; // Точки кривых Безье
	// Очищает данные и перерисовывает изображения
	function RedrawMyImages() {
		points = { isDotGrabbed: 0, data: [] };
		bezierpoints = { isDotGrabbed: 0, data: [] };
		
		context1.fillStyle = "rgb(255, 255, 255)";
		context1.fillRect(0, 0, width, height);
		DrawDots(context1, points, "rgb(0, 0, 0)");
		
		context2.fillStyle = "rgb(255, 255, 255)";
		context2.fillRect(0, 0, width, height);
		DrawBezier(context2, bezierpoints, "rgb(0, 0, 0)");
	}
	// Рисует точки из dots
	function DrawDots(context, dots, color) {
		for(var i = 0; i < dots.data.length; i++) {
			context.fillStyle = color;
			context.fillRect(dots.data[i][0], dots.data[i][1], 1, 1);
		}
	}
	function DrawBezier(context, b_points, color)
	{
		if(bezier_accuracy <= 0) bezier_accuracy = 200;
		
		for(var i = 0; i+2 < b_points.data.length; i+= 2) {
			for(var j = 0; j <= bezier_accuracy; j++) {
				var t = j/bezier_accuracy, x, y;
				
				x = b_points.data[i][0]*(1-t)*(1-t)+2*b_points.data[i+1][0]*(1-t)*t+b_points.data[i+2][0]*t*t;
				y = b_points.data[i][1]*(1-t)*(1-t)+2*b_points.data[i+1][1]*(1-t)*t+b_points.data[i+2][1]*t*t;
				
				context.fillStyle = color;
				context.fillRect(x, y, 1, 1);
			}
		}
	}
	function ApproximatePoints(inp_points, out_points)
	{
		out_points.isDotGrabbed = 0;
		if(inp_points.data.length > 2) {
			var p0 = inp_points.data[0];
			var p1 = [0, 0, 1];
			var p2 = inp_points.data[inp_points.data.length-1];
			var n = inp_points.data.length-1;
			var L = 0, l_1toj = [];
			var x0 = p0[0], x1 = 0, x2 = p2[0];
			var y0 = p0[1], y1 = 0, y2 = p2[1];
			var B1sum = 0;
			// B0j = (1-tj)*(1-tj);
			// B1j = 2*(1-tj)*tj;
			// B2j = tj*tj;
			// l[j] = d(R(j-1), R(j));
			l_1toj[0] = 0;
			for(var j = 1; j <= n; j++) {
				L = L+Math.sqrt(
					(inp_points.data[j-1][0]-inp_points.data[j][0])*(inp_points.data[j-1][0]-inp_points.data[j][0])+
					(inp_points.data[j-1][1]-inp_points.data[j][1])*(inp_points.data[j-1][1]-inp_points.data[j][1])
					);
				l_1toj[j] = L;
			}
			for(var j = 0; j <= n; j++) {
				var t = l_1toj[j]/L;
				var B0j = (1-t)*(1-t);
				var B1j = 2*(1-t)*t;
				var B2j = t*t;
				
				x1 += B1j*(inp_points.data[j][0]-B0j*x0-B2j*x2);
				y1 += B1j*(inp_points.data[j][1]-B0j*y0-B2j*y2);
				B1sum += B1j*B1j; 
			}
			p1[0] = x1/B1sum;
			p1[1] = y1/B1sum;
			out_points.data = [p0, p1, p2];
		} else
			out_points.data = [];
		// Вывод аппроксимированных точек на экран
		context2.fillStyle = "rgb(255, 255, 255)";
		context2.fillRect(0, 0, width, height);
		DrawBezier(context2, bezierpoints, "rgb(128, 64, 255)");
		DrawDots(context2, points, "rgb(0, 0, 0)");
	}
	// Добавляет в dots точку, на которую указали. Здесь event - событие, canvas - холст, на который вы кликнули
	function AddClickedDots(event, canvas, context, dots) {
		var p = canvas;
		var x = event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;
		var y = event.clientY+document.body.scrollTop+document.documentElement.scrollTop;
		while(p) {
			x -= p.offsetLeft;
			y -= p.offsetTop;
			p = p.offsetParent;
		}
		var dot = [x, y, 1];
		if(dots.isDotGrabbed > 0) {
			dots.data[dots.isDotGrabbed-1] = dot;
			dots.isDotGrabbed = 0;
			
			context.fillStyle = "rgb(255, 255, 255)";
			context.fillRect(0, 0, width, height);
			DrawDots(context, dots, "rgb(0, 0, 0)");
		} else {
			for(var i = 0; i < dots.data.length; i++) {
				if((Math.abs(x-dots.data[i][0]) <= 3) &&
					(Math.abs(y-dots.data[i][1]) <= 3)) {
					dots.isDotGrabbed = i+1;
					context.fillStyle = "rgb(0, 255, 0)";
					context.fillRect(dots.data[i][0]-1, dots.data[i][1]-1, 3, 3);
					context.fillStyle = "rgb(0, 0, 0)";
					context.fillRect(dots.data[i][0], dots.data[i][1], 1, 1);
					return;
				}
			}
			context.fillStyle = "rgb(0, 0, 0)";
			context.fillRect(x, y, 1, 1);
			dots.data[dots.data.length] = dot;
		}
	}
	function AddDot(event) {
		AddClickedDots(event, canvas1, context1, points);
	}
	window.onload = function () {
		canvas1 = document.getElementById('canvas1');
		context1 = canvas1.getContext('2d');
		width = canvas1.width;
		height = canvas1.height;
		
		canvas2 = document.getElementById('canvas2');
		context2 = canvas2.getContext('2d');
		canvas2.width = width;
		canvas2.height= height;
		
		RedrawMyImages();
		
		canvas1.addEventListener('click', AddDot);
	}
</script>
</head>
<body style="background: gray;">
<table>
<tr>
	<td>Исходные точки<br/><canvas id="canvas1" width="200" height="200"></canvas></td>
	<td>Аппроксимация кривой Безье 2-го порядка<br/><canvas id="canvas2" width="200" height="200"></canvas></td>
</tr>
<tr>
	<td><button onclick="RedrawMyImages();">Очистить</button></td>
	<td><button onclick="ApproximatePoints(points, bezierpoints);">Аппроксимировать</button></td>
</tr>
</table>
</body>
</html>