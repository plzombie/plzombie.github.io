<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Line detection</title>
<script type="text/javascript">
	var cavnas1, context1, canvas2, context2;
	var width1, height1, width2, height2;
	var pointsdata = [];
	var min_points_in_line = 2;
	function FindLines() {
		min_points_in_line = document.getElementById('numofdots').value;
		if(min_points_in_line < 2) min_points_in_line = 2;
		document.getElementById('numofdots').value = min_points_in_line;
		for(theta = 0; theta < 360; theta++) {
			var sintheta = Math.sin(theta*Math.PI/180);
			var costheta = Math.cos(theta*Math.PI/180);
			
			for(r = 0; r < height2; r++) {
				if(pointsdata[360*r+theta] >= min_points_in_line) {
					r2 = r-height2/2;
					context1.strokeStyle = "rgba(0, 255, 0, 128)";
					context1.beginPath();
					if(Math.abs(sintheta) > Math.abs(costheta)) {
						//alert("s line in r="+r+" r2="+r2+" theta="+theta);
						context1.moveTo(0, r2/sintheta);
						context1.lineTo(200, (r2-200*costheta)/sintheta);
					} else {
						//alert("c line in r="+r+" r2="+r2+" theta="+theta);
						context1.moveTo(r2/costheta, 0);
						context1.lineTo((r2-200*sintheta)/costheta, 200);
					}
					context1.stroke();
				}
			}
		}
	}
	function RedrawMyImages() {
		context1.fillStyle = "rgb(255, 255, 255)";
		context1.fillRect(0, 0, width1, height1);
		context2.fillStyle = "rgb(255, 255, 255)";
		context2.fillRect(0, 0, width2, height2);
		for(i = 0; i < 360*height2; i++) {
			pointsdata[i] = 0;
		}
		document.getElementById('numofdots').value = min_points_in_line;
	}
	function DrawRThetaDiargam(x, y) {
		for(theta = 0; theta < 360; theta++) {
			r = x*Math.cos(theta*Math.PI/180)+y*Math.sin(theta*Math.PI/180);
			var r2 = r+height2/2;
			pointsdata[360*Math.floor(r2+0.5)+theta] = pointsdata[360*Math.floor(r2+0.5)+theta]+1;
			context2.fillStyle = "rgb(0, 0, 0)";
			context2.fillRect(theta, r2, 1, 1);
		}
	}
	function AddDot(event) {
		var p = canvas1;
		var x = event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;
		var y = event.clientY+document.body.scrollTop+document.documentElement.scrollTop;
		while(p) {
			x -= p.offsetLeft;
			y -= p.offsetTop;
			p = p.offsetParent;
		}
		context1.fillStyle = "rgb(0, 0, 0)";
		context1.fillRect(x, y, 1, 1);
		DrawRThetaDiargam(x, y);
		//alert("x "+x+"y "+y+", x "+canvas1.clientLeft+"y "+canvas1.clientTop);
	}
	window.onload = function () {
		canvas1 = document.getElementById('canvas1');
		context1 = canvas1.getContext('2d');
		width1 = canvas1.width;
		height1 = canvas1.height;
		
		canvas2 = document.getElementById('canvas2');
		context2 = canvas2.getContext('2d');
		
		width2 = 360;
		height2 = Math.sqrt(width1*width1+height1*height1)*2+2;
		canvas2.width = width2;
		canvas2.height= height2;
		
		RedrawMyImages();
		
		canvas1.addEventListener('click', AddDot);
	}
</script>
</head>
<body style="background: gray;">
<table>
<tr>
<td>
	<table>
	<tr><td><canvas id="canvas1" width="200" height="200"></canvas></td></tr>
	<tr><td>
		<button onclick="RedrawMyImages();">Очистить</button>
		<button onclick="FindLines();">Вывести линии</button>
		<p style="text-align:center">Мин. точек:<input type="number" min="2" id="numofdots" value="2" size="10"></p>
	</td></tr>
	</table>
</td>
<td><canvas id="canvas2" width="200" height="200"></canvas></td>
</tr>
</table>
</body>
</html>